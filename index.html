<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Paradise Memories</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Poppins:wght@300;400;600&display=swap');

        :root {
            --glow-color: #f900ff;
            --secondary-glow: #00f2ea;
            --win-glow-color: #fff000;
        }

        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Poppins', sans-serif;
            color: #fff;
            background: #000;
        }

        body {
            background: linear-gradient(135deg, #05181b, #2d0052, #58005a, #003634);
        }

        /* --- LOADING SCREEN (NIVRA) --- */
        #loading-screen {
            position: fixed;
            inset: 0;
            background-color: #050505;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            transition: opacity 0.5s ease-out;
            cursor: pointer;
        }
        
        .loading-text-container {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1;
        }

        .nivra-title {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(3rem, 12vmin, 8rem);
            color: #fff;
            letter-spacing: 0.1em;
            margin: 0;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            background: linear-gradient(to bottom, #fff, #aaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .originals-subtitle {
            font-family: 'Poppins', sans-serif;
            font-weight: 300;
            font-size: clamp(1rem, 4vmin, 2.5rem);
            color: var(--secondary-glow);
            letter-spacing: 0.3em;
            margin: 0;
            text-transform: lowercase;
            opacity: 0.8;
        }

        .progress-bar-container {
            width: 60%;
            max-width: 300px;
            height: 4px;
            background-color: #333;
            border-radius: 2px;
            margin-top: 2rem;
            overflow: hidden;
        }
        .progress-bar {
            width: 0%;
            height: 100%;
            background: #fff;
            box-shadow: 0 0 10px #fff;
            transition: width 0.2s ease-out;
        }
        #loading-percentage {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
        }

        /* --- ORIENTATION BLOCKER --- */
        #orientation-blocker {
            display: none;
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 2rem;
        }
        @media (orientation: portrait) {
            #orientation-blocker { display: flex; }
            #game-container { display: none !important; }
        }
        #orientation-blocker i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: var(--glow-color);
            animation: rotate-anim 2s infinite ease-in-out;
        }
        @keyframes rotate-anim {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
            100% { transform: rotate(0deg); }
        }

        /* --- GAME CONTAINER --- */
        #game-container {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        #mute-button {
            position: absolute;
            top: 1vmin;
            right: 1vmin;
            width: 6vh;
            height: 6vh;
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--glow-color);
            color: var(--glow-color);
            border-radius: 50%;
            cursor: pointer;
            z-index: 100;
            font-size: 2.5vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Title - Centered */
        .game-title {
            position: absolute;
            top: 1vmin;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 4vh;
            margin: 0;
            z-index: 10;
            text-shadow: 0 0 10px var(--glow-color);
            pointer-events: none;
            white-space: nowrap;
            background: linear-gradient(180deg, #fff, var(--secondary-glow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- MAIN GAME AREA --- */
        #game-area {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding: 6vh 1vw 9vh 1vw; /* Adjusted for title and UI */
            box-sizing: border-box;
            gap: 1vw;
        }

        .reels-container {
            flex-grow: 1;
            display: flex;
            height: 100%;
            gap: 0.5%;
            padding: 0.8vmin;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid var(--glow-color);
            border-radius: 1.5vmin;
            box-shadow: 0 0 3vmin var(--glow-color);
            backdrop-filter: blur(5px);
            position: relative;
            box-sizing: border-box;
            max-width: 160vh; 
        }

        .reel {
            flex: 1;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(180deg, rgba(0,0,0,0.4) 0%, rgba(249, 0, 255, 0.05) 50%, rgba(0,0,0,0.4) 100%);
            border-radius: 0.5vmin;
            position: relative;
            border-right: 1px solid rgba(255,255,255,0.05);
        }
        .reel:last-child { border-right: none; }
        
        .reel-strip { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
        }
        
        .symbol {
            width: 100%;
            height: 33.333%;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            box-sizing: border-box; 
            position: relative; /* Important for absolute video positioning */
        }
        
        .symbol img {
            width: 98%;
            height: 98%;
            object-fit: contain;
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.8));
            transition: opacity 0.2s;
            z-index: 1;
        }

        /* Video styling within symbol */
        .symbol video {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 105%; /* Slightly larger to cover image */
            height: 105%;
            object-fit: contain;
            z-index: 2;
        }

        /* --- RIGHT PANEL (CONTROLS) --- */
        #right-panel {
            width: 14vh;
            min-width: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 2vh;
            height: 80%;
            z-index: 20;
        }

        #spinButton {
            width: 13vh;
            height: 13vh;
            min-width: 70px;
            min-height: 70px;
            border: 3px solid var(--glow-color);
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 242, 234, 0.3) 0%, rgba(0,0,0,0.8) 100%);
            color: #fff;
            cursor: pointer;
            box-shadow: 0 0 15px var(--glow-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        #spinButton:active { transform: scale(0.95); }
        #spinButton:hover { box-shadow: 0 0 25px var(--glow-color); }
        #spinButton svg { width: 50%; height: 50%; fill: #fff; }

        #autoSpinButton {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8vh; 
            padding: 1.2vh 0; 
            width: 100%;
            border: 1px solid var(--glow-color);
            border-radius: 1vh;
            background: rgba(0,0,0,0.6);
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }
        #autoSpinButton.active {
            background: var(--glow-color);
            color: #000;
            box-shadow: 0 0 10px var(--glow-color);
        }

        /* --- BOTTOM UI PANEL --- */
        #ui-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 8vh;
            background: rgba(0,0,0,0.9);
            border-top: 1px solid var(--glow-color);
            display: flex;
            align-items: center;
            padding: 0 2vw;
            box-sizing: border-box;
            justify-content: space-between;
            z-index: 50;
        }

        .info-group {
            display: flex;
            gap: 3vw;
            align-items: center;
        }

        .info-box {
            font-size: 1.6vh;
            color: #aaa;
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }
        .info-box span {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5vh;
            color: var(--secondary-glow);
        }
        #win-box span { color: var(--win-glow-color); text-shadow: 0 0 5px var(--win-glow-color); }
        
        #message-box {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5vh;
            color: #fff;
            text-shadow: 0 0 10px var(--glow-color);
            white-space: nowrap;
            pointer-events: none;
        }

        #bet-selection-bar {
            display: flex;
            gap: 0.5vw;
        }
        .bet-select-btn {
            font-family: 'Orbitron', sans-serif;
            background: transparent;
            border: 1px solid #555;
            color: #ccc;
            padding: 0.8vh 1.5vh;
            border-radius: 0.5vh;
            cursor: pointer;
            font-size: 1.8vh;
            transition: all 0.2s;
        }
        .bet-select-btn:hover { border-color: #fff; }
        .bet-select-btn.active {
            border-color: var(--glow-color);
            background: rgba(249, 0, 255, 0.3);
            color: #fff;
            box-shadow: 0 0 5px var(--glow-color);
        }

        #win-lines-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        #win-lines-svg { width: 100%; height: 100%; overflow: visible; }
        .win-line { fill: none; stroke: var(--win-glow-color); stroke-width: 6px; stroke-linecap: round; stroke-linejoin: round; filter: drop-shadow(0 0 8px var(--win-glow-color)); stroke-dasharray: 1000; stroke-dashoffset: 1000; animation: draw-line 0.5s ease-out forwards; }
        @keyframes draw-line { to { stroke-dashoffset: 0; } }

        @media (max-height: 500px) {
            #game-area { padding-top: 5vh; padding-bottom: 9vh; }
            .game-title { font-size: 3vh; top: 1vh; }
            #spinButton { width: 11vh; height: 11vh; }
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loading-text-container">
            <h1 class="nivra-title">NIVRA</h1>
            <p class="originals-subtitle">originals</p>
        </div>
        <div class="progress-bar-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        <p id="loading-percentage">0%</p>
    </div>

    <div id="orientation-blocker">
        <i class="fas fa-mobile-screen"></i>
        <h2>Моля, завъртете устройството</h2>
        <p>Играта е оптимизирана за хоризонтален режим</p>
    </div>

    <div id="game-container">
        
        <h1 class="game-title">PARADISE MEMORIES</h1>
        
        <button id="mute-button"><i class="fas fa-volume-high"></i></button>

        <div id="game-area">
            <div class="reels-container">
                <div class="reel" id="reel0"></div>
                <div class="reel" id="reel1"></div>
                <div class="reel" id="reel2"></div>
                <div class="reel" id="reel3"></div>
                <div class="reel" id="reel4"></div>
                 <div id="win-lines-container">
                    <svg id="win-lines-svg"></svg>
                </div>
            </div>
            
            <div id="right-panel">
                <button id="spinButton">
                    <svg viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"></path></svg>
                </button>
                <button id="autoSpinButton">AUTO</button>
            </div>
        </div>

        <div id="ui-panel">
            <div class="info-group">
                <div class="info-box">БАЛАНС:<span id="balance">1000.00</span></div>
                <div class="info-box" id="win-box">ПЕЧАЛБА:<span id="win">0.00</span></div>
            </div>
            
            <div id="message-box">НАТИСНЕТЕ ЗАВЪРТИ</div>
            
            <div id="bet-selection-bar"></div>
        </div>
    </div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {
    
    const loadingScreen = document.getElementById('loading-screen');
    const progressBar = document.getElementById('progress-bar');
    const loadingPercentage = document.getElementById('loading-percentage');
    const gameContainer = document.getElementById('game-container');

    // CONFIGURATION
    const SYMBOLS = {
        'lol1': { weight: 20, src: 'lol1.png', videoSrc: 'lol1_v1.mp4', payout: { '3': 5,  '4': 10,  '5': 20  }},
        'lol2': { weight: 18, src: 'lol2.png', videoSrc: 'lol2_v1.mp4', payout: { '3': 10, '4': 20,  '5': 40  }},
        'lol3': { weight: 15, src: 'lol3.png', videoSrc: 'lol3_v1.mp4', payout: { '3': 15, '4': 30,  '5': 60  }},
        'lol4': { weight: 12, src: 'lol4.png', videoSrc: 'lol4_v1.mp4', payout: { '3': 20, '4': 40,  '5': 80  }},
        'lol5': { weight: 10, src: 'lol5.png', videoSrc: 'lol5_v1.mp4', payout: { '3': 30, '4': 60,  '5': 120 }},
        'lol6': { weight: 8,  src: 'lol6.png', videoSrc: 'lol6_v1.mp4', payout: { '3': 50, '4': 100, '5': 200 }},
        'lol7': { weight: 6,  src: 'lol7.png', videoSrc: 'lol7_v1.mp4', payout: { '3': 100,'4': 200, '5': 400 }},
        'lol8': { weight: 4,  src: 'lol8.png', videoSrc: 'lol8_v1.mp4', payout: { '3': 200,'4': 400, '5': 800 }},
        'lol9': { weight: 3,  src: 'lol9.png', videoSrc: 'lol9_v1.mp4', payout: { '3': 220,'4': 450, '5': 900 }},
        'wild': { weight: 2,  src: 'wild.png', videoSrc: 'wild_v1.mp4', isWild: true, payout: { '3': 250, '4': 500, '5': 1000 }}
    };

    async function preloadAssetsAndStartGame() {
        const SOUND_FILES = ['bg_music_1.mp3', 'bg_music_2.mp3', 'bg_music_3.mp3', 'win_sound.mp3'];
        
        const assetsToLoad = [];
        Object.values(SYMBOLS).forEach(symbol => {
            assetsToLoad.push({type: 'image', src: symbol.src});
            // Important: Preload videos to ensure they play smoothly
            if (symbol.videoSrc) {
                assetsToLoad.push({type: 'video', src: symbol.videoSrc});
            }
        });
        SOUND_FILES.forEach(name => assetsToLoad.push({type: 'audio', src: name}));
        
        let loadedCount = 0;
        const totalCount = assetsToLoad.length;
        
        const promises = assetsToLoad.map(asset => {
            return new Promise((resolve) => {
                const onLoaded = () => {
                    loadedCount++;
                    const percentage = Math.round((loadedCount / totalCount) * 100);
                    progressBar.style.width = `${percentage}%`;
                    loadingPercentage.textContent = `${percentage}%`;
                    resolve();
                };

                if (asset.type === 'image') {
                    const img = new Image();
                    img.src = asset.src;
                    img.onload = onLoaded;
                    img.onerror = onLoaded;
                } else if (asset.type === 'audio') {
                     const media = new Audio();
                     media.addEventListener('canplaythrough', onLoaded, { once: true });
                     media.addEventListener('error', onLoaded, { once: true });
                     media.src = asset.src;
                     setTimeout(onLoaded, 1000); // Timeout fallback
                } else if (asset.type === 'video') {
                    // Create invisible video element to force cache
                    const vid = document.createElement('video');
                    vid.preload = 'auto';
                    vid.muted = true;
                    vid.playsInline = true; // Crucial for iOS
                    vid.onloadeddata = onLoaded;
                    vid.onerror = onLoaded;
                    vid.src = asset.src;
                    setTimeout(onLoaded, 1500); // Timeout fallback
                }
            });
        });

        await Promise.all(promises);
        
        loadingPercentage.textContent = "TAP TO START";
        
        loadingScreen.addEventListener('click', () => {
            loadingScreen.style.opacity = '0';
            goFullscreen();
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                gameContainer.style.display = 'flex';
                initializeGameLogic(1000.00);
                window.dispatchEvent(new Event('resize'));
            }, 500);
        }, { once: true });
    }
    
    function goFullscreen() {
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
            elem.requestFullscreen().catch(() => {});
        } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen();
        }
    }
    
    function initializeGameLogic(initialBalance) {
        const REEL_COUNT = 5;
        const SYMBOLS_PER_REEL_VISIBLE = 3;
        const PAYLINES = [
            [1, 1, 1, 1, 1], [0, 0, 0, 0, 0], [2, 2, 2, 2, 2], [0, 1, 2, 1, 0], [2, 1, 0, 1, 2],
            [0, 0, 1, 2, 2], [2, 2, 1, 0, 0], [1, 0, 0, 0, 1], [1, 2, 2, 2, 1], [0, 1, 1, 1, 2]
        ];
        
        const BET_AMOUNTS = [1, 2, 5, 10, 20, 50, 100];
        
        let balance = initialBalance;
        let currentBetIndex = 2;
        let bet = BET_AMOUNTS[currentBetIndex];
        let isSpinning = false;
        let isAutoSpinning = false;
        let isMuted = false;

        const backgroundMusicFiles = ['bg_music_1.mp3', 'bg_music_2.mp3', 'bg_music_3.mp3'];
        let currentTrackIndex = 0;
        const bgMusicPlayer = new Audio();
        bgMusicPlayer.volume = 0.3;
        const winSound = new Audio('win_sound.mp3');
        const allSounds = [bgMusicPlayer, winSound];

        const spinButton = document.getElementById('spinButton');
        const autoSpinButton = document.getElementById('autoSpinButton');
        const balanceDisplay = document.getElementById('balance');
        const winDisplay = document.getElementById('win');
        const reels = Array.from({ length: REEL_COUNT }, (_, i) => document.getElementById(`reel${i}`));
        const winLinesSvg = document.getElementById('win-lines-svg');
        const betSelectionBar = document.getElementById('bet-selection-bar');
        const messageBox = document.getElementById('message-box');
        const muteButton = document.getElementById('mute-button');
        
        const reelStrips = [];
        
        function playNextTrack() {
            if (backgroundMusicFiles.length === 0) return;
            currentTrackIndex = (currentTrackIndex + 1) % backgroundMusicFiles.length;
            bgMusicPlayer.src = backgroundMusicFiles[currentTrackIndex];
            bgMusicPlayer.play().catch(() => {});
        }
        bgMusicPlayer.addEventListener('ended', playNextTrack);

        function manageBackgroundMusic(shouldPlay) {
            if (shouldPlay && bgMusicPlayer.paused && !isMuted) {
                if(!bgMusicPlayer.src) bgMusicPlayer.src = backgroundMusicFiles[0];
                bgMusicPlayer.play().catch(() => {});
            } else if (!shouldPlay && !bgMusicPlayer.paused) {
                bgMusicPlayer.pause();
            }
        }
        
        function toggleMute() {
            isMuted = !isMuted;
            allSounds.forEach(sound => sound.muted = isMuted);
            muteButton.innerHTML = `<i class="fas ${isMuted ? 'fa-volume-xmark' : 'fa-volume-high'}"></i>`;
            if (isMuted) bgMusicPlayer.pause();
            else manageBackgroundMusic(true);
        }
        muteButton.addEventListener('click', toggleMute);

        function createWeightedStrip() {
            const strip = [];
            for (const key in SYMBOLS) {
                for (let i = 0; i < SYMBOLS[key].weight; i++) strip.push(key);
            }
            return strip.sort(() => Math.random() - 0.5);
        }
        
        function initializeReels() {
            reels.forEach((reelElement) => {
                reelElement.innerHTML = '';
                const reelStripElement = document.createElement('div');
                reelStripElement.className = 'reel-strip';
                const weightedStrip = createWeightedStrip();
                reelStrips.push(weightedStrip);

                const totalSymbols = weightedStrip.length * 3; 
                for(let i = 0; i < totalSymbols; i++) {
                    const symbolKey = weightedStrip[i % weightedStrip.length];
                    const symbolElement = document.createElement('div');
                    symbolElement.className = 'symbol';
                    symbolElement.style.height = `${reelElement.offsetHeight / 3}px`;
                    
                    const img = document.createElement('img');
                    img.src = SYMBOLS[symbolKey].src;
                    symbolElement.appendChild(img);
                    reelStripElement.appendChild(symbolElement);
                }
                reelElement.appendChild(reelStripElement);
            });
        }
        
        window.addEventListener('resize', () => {
            reels.forEach(reel => {
                const h = reel.offsetHeight / 3;
                const symbols = reel.querySelectorAll('.symbol');
                symbols.forEach(s => s.style.height = `${h}px`);
                const strip = reel.querySelector('.reel-strip');
                if(strip) strip.style.transform = `translateY(0px)`;
            });
        });

        function initializeUI() {
            betSelectionBar.innerHTML = '';
            BET_AMOUNTS.forEach((amount, index) => {
                const button = document.createElement('button');
                button.classList.add('bet-select-btn');
                button.textContent = amount;
                button.dataset.index = index;
                betSelectionBar.appendChild(button);
            });
            updateBetSelection();
        }
        
        function updateBetSelection() {
            bet = BET_AMOUNTS[currentBetIndex];
            document.querySelectorAll('.bet-select-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.index) === currentBetIndex);
            });
        }

        async function spin() {
            if (isSpinning) return;
            if (balance < bet) {
                if(isAutoSpinning) toggleAutoSpin();
                messageBox.textContent = "НЯМА КРЕДИТИ";
                return;
            }

            if (bgMusicPlayer.paused) {
                 if(!bgMusicPlayer.src) bgMusicPlayer.src = backgroundMusicFiles[currentTrackIndex];
                 manageBackgroundMusic(true);
            }

            isSpinning = true;
            spinButton.style.filter = "grayscale(100%)";
            
            // Clean up previous videos and lines
            clearAnimations();
            
            winDisplay.textContent = "0.00";
            messageBox.textContent = "УСПЕХ!";
            
            balance -= bet;
            balanceDisplay.textContent = balance.toFixed(2);
            
            let results = [];
            const finalIndexes = [];
            
            for (let i = 0; i < REEL_COUNT; i++) {
                const strip = reelStrips[i];
                const randomIndex = Math.floor(Math.random() * strip.length);
                finalIndexes.push(randomIndex);
                results.push([
                    strip[(randomIndex + 0) % strip.length],
                    strip[(randomIndex + 1) % strip.length],
                    strip[(randomIndex + 2) % strip.length]
                ]);
            }
            
            const spinPromises = reels.map((reel, i) => {
                return new Promise(async (resolve) => {
                    const reelStripElement = reel.querySelector('.reel-strip');
                    const symbolHeight = reel.offsetHeight / SYMBOLS_PER_REEL_VISIBLE;
                    reel.querySelectorAll('.symbol').forEach(s => s.style.height = `${symbolHeight}px`);

                    const strip = reelStrips[i];
                    const baseTargetPosition = finalIndexes[i] * symbolHeight;
                    const loopOffset = strip.length * symbolHeight;
                    
                    reelStripElement.style.transition = 'none';
                    reelStripElement.style.transform = `translateY(-${baseTargetPosition + loopOffset}px)`;
                    reelStripElement.offsetHeight; 

                    const duration = 1.0 + (i * 0.2); 
                    reelStripElement.style.transition = `transform ${duration}s cubic-bezier(0.15, 0.9, 0.3, 1)`;
                    reelStripElement.style.transform = `translateY(-${baseTargetPosition}px)`;

                    await new Promise(res => setTimeout(res, duration * 1000));
                    resolve();
                });
            });
            
            await Promise.all(spinPromises);

            const { totalWin, winningLines } = calculateWin(results);
            
            if (totalWin > 0) {
                messageBox.textContent = `ПЕЧАЛБА: ${totalWin.toFixed(2)}`;
                balance += totalWin;
                balanceDisplay.textContent = balance.toFixed(2);
                
                manageBackgroundMusic(false);
                winSound.play();
                
                winDisplay.textContent = totalWin.toFixed(2);
                drawWinningLines(winningLines);
                
                // Play video animations
                await playWinVideos(winningLines, finalIndexes);
                
                manageBackgroundMusic(true);
            } else {
                messageBox.textContent = "ОПИТАЙ ОТНОВО";
            }
            
            if (isAutoSpinning) {
                setTimeout(spin, 500);
            } else {
                isSpinning = false;
                spinButton.style.filter = "none";
            }
        }

        async function playWinVideos(winningLines, finalIndexes) {
            const playedPositions = new Set();
            const videoPromises = [];

            winningLines.forEach(line => {
                const payingSymbolKey = line.payingSymbol;
                const symbolData = SYMBOLS[payingSymbolKey];
                
                if (!symbolData || !symbolData.videoSrc) return;

                line.coords.forEach(coord => {
                    // Prevent playing multiple videos on the same cell if it participates in multiple lines
                    const posKey = `${coord.reel}-${coord.row}`;
                    if (playedPositions.has(posKey)) return;
                    playedPositions.add(posKey);

                    const domIndex = finalIndexes[coord.reel] + coord.row;
                    const stripElement = reels[coord.reel].querySelector('.reel-strip');
                    if (stripElement && stripElement.children[domIndex]) {
                        const symbolEl = stripElement.children[domIndex];
                        const imgEl = symbolEl.querySelector('img');

                        // Create and inject video
                        const videoProm = new Promise(resolve => {
                            const video = document.createElement('video');
                            video.src = symbolData.videoSrc;
                            video.muted = true; // Required for auto-play on mobile
                            video.playsInline = true; // Required for iOS
                            video.autoplay = true;
                            
                            // Style handled by CSS, but good to ensure
                            video.className = 'win-video'; 
                            
                            // Hide image, show video
                            if(imgEl) imgEl.style.opacity = '0';
                            symbolEl.appendChild(video);

                            const cleanup = () => {
                                if(imgEl) imgEl.style.opacity = '1';
                                if(video.parentNode === symbolEl) symbolEl.removeChild(video);
                                resolve();
                            };

                            video.onended = cleanup;
                            video.onerror = cleanup;
                        });
                        videoPromises.push(videoProm);
                    }
                });
            });

            // If we have videos, wait for them. If not (just lines), wait a bit.
            if (videoPromises.length > 0) {
                await Promise.all(videoPromises);
            } else {
                await new Promise(r => setTimeout(r, 1500));
            }
        }
        
        spinButton.addEventListener('click', () => spin());
        
        autoSpinButton.addEventListener('click', toggleAutoSpin);
        function toggleAutoSpin() {
            isAutoSpinning = !isAutoSpinning;
            autoSpinButton.classList.toggle('active', isAutoSpinning);
            autoSpinButton.textContent = isAutoSpinning ? "СТОП" : "AUTO";
            if (isAutoSpinning && !isSpinning) spin();
        }

        betSelectionBar.addEventListener('click', (e) => {
            if (isSpinning) return;
            const button = e.target.closest('.bet-select-btn');
            if (button) {
                currentBetIndex = parseInt(button.dataset.index);
                updateBetSelection();
            }
        });

        function clearAnimations() {
            winLinesSvg.innerHTML = '';
            // Remove any stuck videos
            document.querySelectorAll('video').forEach(v => v.remove());
            document.querySelectorAll('.symbol img').forEach(img => img.style.opacity = '1');
        }

        function calculateWin(results) {
            let totalWin = 0; 
            const winningLines = [];
            
            PAYLINES.forEach((line) => {
                let payingSymbolKey = null;
                for (let i = 0; i < REEL_COUNT; i++) {
                    const symbol = results[i][line[i]];
                    if (!SYMBOLS[symbol]?.isWild) { payingSymbolKey = symbol; break; }
                }
                if (payingSymbolKey === null) payingSymbolKey = 'wild';

                let matchCount = 0;
                for (let i = 0; i < REEL_COUNT; i++) {
                    const currentSymbolKey = results[i][line[i]];
                    if (currentSymbolKey === payingSymbolKey || SYMBOLS[currentSymbolKey]?.isWild) matchCount++;
                    else break;
                }

                if (matchCount >= 3) {
                    const symbolData = SYMBOLS[payingSymbolKey];
                    if (symbolData?.payout?.[matchCount]) {
                        totalWin += symbolData.payout[matchCount] * bet;
                        const lineCoords = [];
                        for (let i = 0; i < matchCount; i++) lineCoords.push({reel: i, row: line[i]});
                        winningLines.push({coords: lineCoords, payingSymbol: payingSymbolKey});
                    }
                }
            });
            return { totalWin, winningLines };
        }
        
        function drawWinningLines(winningLines) {
            winLinesSvg.innerHTML = '';
            const svgRect = winLinesSvg.getBoundingClientRect();
            if (reels.length === 0 || !svgRect) return;

            winningLines.forEach(lineData => {
                const points = lineData.coords.map(coord => {
                    const reel = reels[coord.reel];
                    const reelRect = reel.getBoundingClientRect();
                    const symbolHeight = reelRect.height / SYMBOLS_PER_REEL_VISIBLE;
                    
                    const x = reelRect.left - svgRect.left + (reelRect.width / 2);
                    const y = reelRect.top - svgRect.top + (coord.row * symbolHeight) + (symbolHeight / 2);
                    return `${x},${y}`;
                }).join(' ');
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
                line.setAttribute('points', points);
                line.setAttribute('class', 'win-line');
                winLinesSvg.appendChild(line);
            });
        }
        
        initializeReels();
        initializeUI();
        window.dispatchEvent(new Event('resize'));
    }
    
    preloadAssetsAndStartGame();
});
</script>
</body>
</html>

